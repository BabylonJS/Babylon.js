!(function(e,t){var r=[],a=e.BABYLON||this.BABYLON;"object"==typeof exports&&"object"==typeof module?(a=a||require("babylonjs"),module.exports=t(a)):"function"==typeof define&&define.amd?(r.push("babylonjs"),define("babylonjs-serializers",r,t)):"object"==typeof exports?(a=a||require("babylonjs"),exports["babylonjs-serializers"]=t(a)):e.BABYLON=t(a)})(this,(function(e){e=e||this.BABYLON;var e;this&&this.__decorate,this&&this.__extends||(function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}})();!(function(e){var t=(function(){function t(){}return t.OBJ=function(t,r,a,i){var n=[],o=1;r&&(a||(a="mat"),n.push("mtllib "+a+".mtl"));for(var s=0;s<t.length;s++){n.push("g object"+s),n.push("o object_"+s);var l=null;if(i){var u=e.Matrix.Translation(t[s].position.x,t[s].position.y,t[s].position.z);l=e.Matrix.Translation(-t[s].position.x,-t[s].position.y,-t[s].position.z),t[s].bakeTransformIntoVertices(u)}if(r){var c=t[s].material;c&&n.push("usemtl "+c.id)}var f=t[s].geometry;if(f){var h=f.getVerticesData("position"),d=f.getVerticesData("normal"),p=f.getVerticesData("uv"),m=f.getIndices(),g=0;if(h&&d&&p&&m){for(var T=0;T<h.length;T+=3)n.push("v "+h[T]+" "+h[T+1]+" "+h[T+2]),g++;for(T=0;T<d.length;T+=3)n.push("vn "+d[T]+" "+d[T+1]+" "+d[T+2]);for(T=0;T<p.length;T+=2)n.push("vt "+p[T]+" "+p[T+1]);for(T=0;T<m.length;T+=3)n.push("f "+(m[T+2]+o)+"/"+(m[T+2]+o)+"/"+(m[T+2]+o)+" "+(m[T+1]+o)+"/"+(m[T+1]+o)+"/"+(m[T+1]+o)+" "+(m[T]+o)+"/"+(m[T]+o)+"/"+(m[T]+o));i&&l&&t[s].bakeTransformIntoVertices(l),o+=g}}}return n.join("\n")},t.MTL=function(e){var t=[],r=e.material;t.push("newmtl mat1"),t.push("  Ns "+r.specularPower.toFixed(4)),t.push("  Ni 1.5000"),t.push("  d "+r.alpha.toFixed(4)),t.push("  Tr 0.0000"),t.push("  Tf 1.0000 1.0000 1.0000"),t.push("  illum 2"),t.push("  Ka "+r.ambientColor.r.toFixed(4)+" "+r.ambientColor.g.toFixed(4)+" "+r.ambientColor.b.toFixed(4)),t.push("  Kd "+r.diffuseColor.r.toFixed(4)+" "+r.diffuseColor.g.toFixed(4)+" "+r.diffuseColor.b.toFixed(4)),t.push("  Ks "+r.specularColor.r.toFixed(4)+" "+r.specularColor.g.toFixed(4)+" "+r.specularColor.b.toFixed(4)),t.push("  Ke "+r.emissiveColor.r.toFixed(4)+" "+r.emissiveColor.g.toFixed(4)+" "+r.emissiveColor.b.toFixed(4));return r.ambientTexture&&t.push("  map_Ka "+r.ambientTexture.name),r.diffuseTexture&&t.push("  map_Kd "+r.diffuseTexture.name),r.specularTexture&&t.push("  map_Ks "+r.specularTexture.name),r.bumpTexture&&t.push("  map_bump -imfchan z "+r.bumpTexture.name),r.opacityTexture&&t.push("  map_d "+r.opacityTexture.name),t.join("\n")},t})();e.OBJExport=t})(e||(e={})),e.Effect.ShadersStore.setAlphaToOnePixelShader="precision highp float;\nuniform sampler2D textureSampler;\nvarying vec2 vUV;\nvoid main(void) {\nvec4 color=texture2D(textureSampler,vUV);\ngl_FragColor=vec4(color.rgb,1.0);\n}";var e;!(function(e){var t=(function(){function t(){}return t.GLTFAsync=function(t,r,a){return t.whenReadyAsync().then((function(){var i=r.replace(/\.[^\/.]+$/,"");return new e.GLTF2._Exporter(t,a)._generateGLTFAsync(i)}))},t.GLBAsync=function(t,r,a){return t.whenReadyAsync().then((function(){var i=r.replace(/\.[^\/.]+$/,"");return new e.GLTF2._Exporter(t,a)._generateGLBAsync(i)}))},t})();e.GLTF2Export=t})(e||(e={}));var e;!(function(e){!(function(t){var r=(function(){function r(e,t){this.asset={generator:"BabylonJS",version:"2.0"},this.babylonScene=e,this.bufferViews=[],this.accessors=[],this.meshes=[],this.scenes=[],this.nodes=[],this.images=[],this.materials=[],this.materialMap=[],this.textures=[],this.samplers=[],this.animations=[],this.imageData={},this.convertToRightHandedSystem=!this.babylonScene.useRightHandedSystem;var r=t||{};this.shouldExportTransformNode=r.shouldExportTransformNode?r.shouldExportTransformNode:function(e){return!0},this.animationSampleRate=r.animationSampleRate?r.animationSampleRate:1/60}return r.prototype.reorderIndicesBasedOnPrimitiveMode=function(t,r,a,i,n){switch(r){case e.Material.TriangleFillMode:i||(i=0);for(var o=t.indexStart,s=t.indexStart+t.indexCount;o<s;o+=3){var l=i+4*o,u=n.getUInt32(l+4),c=n.getUInt32(l+8);n.setUInt32(c,l+4),n.setUInt32(u,l+8)}break;case e.Material.TriangleFanDrawMode:for(var o=t.indexStart+t.indexCount-1,f=t.indexStart;o>=f;--o)n.setUInt32(a[o],i),i+=4;break;case e.Material.TriangleStripDrawMode:t.indexCount>=3&&(n.setUInt32(a[t.indexStart+2],i+4),n.setUInt32(a[t.indexStart+1],i+8))}},r.prototype.reorderVertexAttributeDataBasedOnPrimitiveMode=function(t,r,a,i,n,o,s){if(this.convertToRightHandedSystem&&a===e.Material.ClockWiseSideOrientation)switch(r){case e.Material.TriangleFillMode:this.reorderTriangleFillMode(t,r,a,i,n,o,s);break;case e.Material.TriangleStripDrawMode:this.reorderTriangleStripDrawMode(t,r,a,i,n,o,s);break;case e.Material.TriangleFanDrawMode:this.reorderTriangleFanMode(t,r,a,i,n,o,s)}},r.prototype.reorderTriangleFillMode=function(t,r,a,i,n,o,s){var l=this.getVertexBufferFromMesh(i,t.getMesh());if(l){var u=l.byteStride/e.VertexBuffer.GetTypeByteLength(l.type);if(t.verticesCount%3!=0)e.Tools.Error("The submesh vertices for the triangle fill mode is not divisible by 3!");else{var c=[],f=0;switch(i){case e.VertexBuffer.PositionKind:case e.VertexBuffer.NormalKind:for(var h=t.verticesStart;h<t.verticesStart+t.verticesCount;h+=3)f=h*u,c.push(e.Vector3.FromArray(n,f)),c.push(e.Vector3.FromArray(n,f+2*u)),c.push(e.Vector3.FromArray(n,f+u));break;case e.VertexBuffer.TangentKind:for(var h=t.verticesStart;h<t.verticesStart+t.verticesCount;h+=3)f=h*u,c.push(e.Vector4.FromArray(n,f)),c.push(e.Vector4.FromArray(n,f+2*u)),c.push(e.Vector4.FromArray(n,f+u));break;case e.VertexBuffer.ColorKind:for(var d=l.getSize(),h=t.verticesStart;h<t.verticesStart+t.verticesCount;h+=d)f=h*u,4===d?(c.push(e.Vector4.FromArray(n,f)),c.push(e.Vector4.FromArray(n,f+2*u)),c.push(e.Vector4.FromArray(n,f+u))):(c.push(e.Vector3.FromArray(n,f)),c.push(e.Vector3.FromArray(n,f+2*u)),c.push(e.Vector3.FromArray(n,f+u)));break;case e.VertexBuffer.UVKind:case e.VertexBuffer.UV2Kind:for(var h=t.verticesStart;h<t.verticesStart+t.verticesCount;h+=3)f=h*u,c.push(e.Vector2.FromArray(n,f)),c.push(e.Vector2.FromArray(n,f+2*u)),c.push(e.Vector2.FromArray(n,f+u));break;default:e.Tools.Error("Unsupported Vertex Buffer type: "+i)}this.writeVertexAttributeData(c,o,i,n,s)}}else e.Tools.Warn("reorderTriangleFillMode: Vertex Buffer Kind "+i+" not present!")},r.prototype.reorderTriangleStripDrawMode=function(t,r,a,i,n,o,s){var l=this.getVertexBufferFromMesh(i,t.getMesh());if(l){var u=l.byteStride/e.VertexBuffer.GetTypeByteLength(l.type),c=[],f=0;switch(i){case e.VertexBuffer.PositionKind:case e.VertexBuffer.NormalKind:f=t.verticesStart,c.push(e.Vector3.FromArray(n,f+2*u)),c.push(e.Vector3.FromArray(n,f+u));break;case e.VertexBuffer.TangentKind:for(var h=t.verticesStart+t.verticesCount-1;h>=t.verticesStart;--h)f=h*u,c.push(e.Vector4.FromArray(n,f));break;case e.VertexBuffer.ColorKind:for(var h=t.verticesStart+t.verticesCount-1;h>=t.verticesStart;--h)f=h*u,4===l.getSize()?c.push(e.Vector4.FromArray(n,f)):c.push(e.Vector3.FromArray(n,f));break;case e.VertexBuffer.UVKind:case e.VertexBuffer.UV2Kind:for(var h=t.verticesStart+t.verticesCount-1;h>=t.verticesStart;--h)f=h*u,c.push(e.Vector2.FromArray(n,f));break;default:e.Tools.Error("Unsupported Vertex Buffer type: "+i)}this.writeVertexAttributeData(c,o+12,i,n,s)}else e.Tools.Warn("reorderTriangleStripDrawMode: Vertex buffer kind "+i+" not present!")},r.prototype.reorderTriangleFanMode=function(t,r,a,i,n,o,s){var l=this.getVertexBufferFromMesh(i,t.getMesh());if(l){var u=l.byteStride/e.VertexBuffer.GetTypeByteLength(l.type),c=[],f=0;switch(i){case e.VertexBuffer.PositionKind:case e.VertexBuffer.NormalKind:for(var h=t.verticesStart+t.verticesCount-1;h>=t.verticesStart;--h)f=h*u,c.push(e.Vector3.FromArray(n,f));break;case e.VertexBuffer.TangentKind:for(var h=t.verticesStart+t.verticesCount-1;h>=t.verticesStart;--h)f=h*u,c.push(e.Vector4.FromArray(n,f));break;case e.VertexBuffer.ColorKind:for(var h=t.verticesStart+t.verticesCount-1;h>=t.verticesStart;--h)f=h*u,c.push(e.Vector4.FromArray(n,f)),4===l.getSize()?c.push(e.Vector4.FromArray(n,f)):c.push(e.Vector3.FromArray(n,f));break;case e.VertexBuffer.UVKind:case e.VertexBuffer.UV2Kind:for(var h=t.verticesStart+t.verticesCount-1;h>=t.verticesStart;--h)f=h*u,c.push(e.Vector2.FromArray(n,f));break;default:e.Tools.Error("Unsupported Vertex Buffer type: "+i)}this.writeVertexAttributeData(c,o,i,n,s)}else e.Tools.Warn("reorderTriangleFanMode: Vertex buffer kind "+i+" not present!")},r.prototype.writeVertexAttributeData=function(r,a,i,n,o){for(var s=0,l=r;s<l.length;s++){var u=l[s];!this.convertToRightHandedSystem||i===e.VertexBuffer.ColorKind||u instanceof e.Vector2||(u instanceof e.Vector3?i===e.VertexBuffer.PositionKind?t._GLTFUtilities.GetRightHandedPositionVector3FromRef(u):t._GLTFUtilities.GetRightHandedNormalVector3FromRef(u):t._GLTFUtilities.GetRightHandedVector4FromRef(u));for(var c=0,f=u.asArray();c<f.length;c++){var h=f[c];o.setFloat32(h,a),a+=4}}},r.prototype.writeAttributeData=function(r,a,i,n){var o,s=i/4,l=[];switch(r){case e.VertexBuffer.PositionKind:for(var u=0,c=a.length/s;u<c;++u){o=u*s;var f=e.Vector3.FromArray(a,o);this.convertToRightHandedSystem&&t._GLTFUtilities.GetRightHandedPositionVector3FromRef(f),l.push(f.asArray())}break;case e.VertexBuffer.NormalKind:for(var u=0,h=a.length/s;u<h;++u){o=u*s;var f=e.Vector3.FromArray(a,o);this.convertToRightHandedSystem&&t._GLTFUtilities.GetRightHandedNormalVector3FromRef(f),l.push(f.asArray())}break;case e.VertexBuffer.TangentKind:for(var u=0,d=a.length/s;u<d;++u){o=u*s;var f=e.Vector4.FromArray(a,o);this.convertToRightHandedSystem&&t._GLTFUtilities.GetRightHandedVector4FromRef(f),l.push(f.asArray())}break;case e.VertexBuffer.ColorKind:for(var u=0,p=a.length/s;u<p;++u){o=u*s;var f=3===s?e.Vector3.FromArray(a,o):e.Vector4.FromArray(a,o);l.push(f.asArray())}break;case e.VertexBuffer.UVKind:case e.VertexBuffer.UV2Kind:for(var u=0,m=a.length/s;u<m;++u)o=u*s,l.push((this.convertToRightHandedSystem,[a[o],a[o+1]]));break;default:e.Tools.Warn("Unsupported Vertex Buffer Type: "+r),l=[]}for(var g=0,T=l;g<T.length;g++)for(var y=T[g],v=0,x=y;v<x.length;v++){var b=x[v];n.setFloat32(b)}},r.prototype.generateJSON=function(e,r,a){var i,n,o,s=this,l={byteLength:this.totalByteLength},u=this.totalByteLength,c={asset:this.asset};return l.byteLength&&(c.buffers=[l]),this.nodes&&this.nodes.length&&(c.nodes=this.nodes),this.meshes&&this.meshes.length&&(c.meshes=this.meshes),this.scenes&&this.scenes.length&&(c.scenes=this.scenes,c.scene=0),this.bufferViews&&this.bufferViews.length&&(c.bufferViews=this.bufferViews),this.accessors&&this.accessors.length&&(c.accessors=this.accessors),this.animations&&this.animations.length&&(c.animations=this.animations),this.materials&&this.materials.length&&(c.materials=this.materials),this.textures&&this.textures.length&&(c.textures=this.textures),this.samplers&&this.samplers.length&&(c.samplers=this.samplers),this.images&&this.images.length&&(e?(c.images=[],this.images.forEach((function(e){e.uri&&(n=s.imageData[e.uri],i=e.uri.split(".")[0]+" image",o=t._GLTFUtilities.CreateBufferView(0,u,n.data.length,void 0,i),u+=n.data.buffer.byteLength,s.bufferViews.push(o),e.bufferView=s.bufferViews.length-1,e.name=i,e.mimeType=n.mimeType,e.uri=void 0,c.images||(c.images=[]),c.images.push(e))})),l.byteLength=u):c.images=this.images),e||(l.uri=r+".bin"),a?JSON.stringify(c,null,2):JSON.stringify(c)},r.prototype._generateGLTFAsync=function(t){var r=this;return this._generateBinaryAsync().then((function(a){var i=r.generateJSON(!1,t,!0),n=new Blob([a],{type:"application/octet-stream"}),o=t+".gltf",s=t+".bin",l=new e.GLTFData;if(l.glTFFiles[o]=i,l.glTFFiles[s]=n,r.imageData)for(var u in r.imageData)l.glTFFiles[u]=new Blob([r.imageData[u].data],{type:r.imageData[u].mimeType});return l}))},r.prototype._generateBinaryAsync=function(){var e=new a(4);return this.createSceneAsync(this.babylonScene,e).then((function(){return e.getArrayBuffer()}))},r.prototype._getPadding=function(e){var t=e%4;return 0===t?t:4-t},r.prototype._generateGLBAsync=function(t){var r=this;return this._generateBinaryAsync().then((function(a){var i=r.generateJSON(!0),n=t+".glb",o=i.length,s=0;for(var l in r.imageData)s+=r.imageData[l].data.byteLength;var u=r._getPadding(o),c=r._getPadding(a.byteLength),f=r._getPadding(s),h=28+o+u+a.byteLength+c+s+f,d=new ArrayBuffer(12),p=new DataView(d);p.setUint32(0,1179937895,!0),p.setUint32(4,2,!0),p.setUint32(8,h,!0);var m=new ArrayBuffer(8+o+u),g=new DataView(m);g.setUint32(0,o+u,!0),g.setUint32(4,1313821514,!0);for(var T=new Uint8Array(m,8),y=0;y<o;++y)T[y]=i.charCodeAt(y);for(var v=new Uint8Array(m,8+o),y=0;y<u;++y)v[y]=32;var x=new ArrayBuffer(8),b=new DataView(x);b.setUint32(0,a.byteLength+s+f,!0),b.setUint32(4,5130562,!0);for(var A=new ArrayBuffer(c),F=new Uint8Array(A),y=0;y<c;++y)F[y]=0;for(var _=new ArrayBuffer(f),M=new Uint8Array(_),y=0;y<f;++y)M[y]=0;var R=[d,m,x,a];for(var l in r.imageData)R.push(r.imageData[l].data.buffer);R.push(A),R.push(_);var C=new Blob(R,{type:"application/octet-stream"}),S=new e.GLTFData;return S.glTFFiles[n]=C,S}))},r.prototype.setNodeTransformation=function(r,a){a.position.equalsToFloats(0,0,0)||(r.translation=this.convertToRightHandedSystem?t._GLTFUtilities.GetRightHandedPositionVector3(a.position).asArray():a.position.asArray()),a.scaling.equalsToFloats(1,1,1)||(r.scale=a.scaling.asArray());var i=e.Quaternion.RotationYawPitchRoll(a.rotation.y,a.rotation.x,a.rotation.z);a.rotationQuaternion&&i.multiplyInPlace(a.rotationQuaternion),0===i.x&&0===i.y&&0===i.z&&1===i.w||(this.convertToRightHandedSystem&&t._GLTFUtilities.GetRightHandedQuaternionFromRef(i),r.rotation=i.normalize().asArray())},r.prototype.getVertexBufferFromMesh=function(e,t){if(t.isVerticesDataPresent(e)){var r=t.getVertexBuffer(e);if(r)return r}return null},r.prototype.createBufferViewKind=function(r,a,i,n){var o=a instanceof e.Mesh?a:a instanceof e.InstancedMesh?a.sourceMesh:null;if(o){var s=o.getVerticesData(r);if(s){var l=4*s.length,u=t._GLTFUtilities.CreateBufferView(0,i.getByteOffset(),l,n,r+" - "+o.name);this.bufferViews.push(u),this.writeAttributeData(r,s,n,i)}}},r.prototype.getMeshPrimitiveMode=function(t){return t instanceof e.LinesMesh?e.Material.LineListDrawMode:t.material?t.material.fillMode:e.Material.TriangleFillMode},r.prototype.setPrimitiveMode=function(t,r){switch(r){case e.Material.TriangleFillMode:break;case e.Material.TriangleStripDrawMode:t.mode=5;break;case e.Material.TriangleFanDrawMode:t.mode=6;break;case e.Material.PointListDrawMode:t.mode=0;case e.Material.PointFillMode:t.mode=0;break;case e.Material.LineLoopDrawMode:t.mode=2;break;case e.Material.LineListDrawMode:t.mode=1;break;case e.Material.LineStripDrawMode:t.mode=3}},r.prototype.setAttributeKind=function(t,r){switch(r){case e.VertexBuffer.PositionKind:t.attributes.POSITION=this.accessors.length-1;break;case e.VertexBuffer.NormalKind:t.attributes.NORMAL=this.accessors.length-1;break;case e.VertexBuffer.ColorKind:t.attributes.COLOR_0=this.accessors.length-1;break;case e.VertexBuffer.TangentKind:t.attributes.TANGENT=this.accessors.length-1;break;case e.VertexBuffer.UVKind:t.attributes.TEXCOORD_0=this.accessors.length-1;break;case e.VertexBuffer.UV2Kind:t.attributes.TEXCOORD_1=this.accessors.length-1;break;default:e.Tools.Warn("Unsupported Vertex Buffer Type: "+r)}},r.prototype.setPrimitiveAttributes=function(r,a,i){var n,o,s,l=null;a instanceof e.Mesh?l=a:a instanceof e.InstancedMesh&&(l=a.sourceMesh);var u=[{kind:e.VertexBuffer.PositionKind,accessorType:"VEC3",byteStride:12},{kind:e.VertexBuffer.NormalKind,accessorType:"VEC3",byteStride:12},{kind:e.VertexBuffer.ColorKind,accessorType:"VEC4",byteStride:16},{kind:e.VertexBuffer.TangentKind,accessorType:"VEC4",byteStride:16},{kind:e.VertexBuffer.UVKind,accessorType:"VEC2",byteStride:8},{kind:e.VertexBuffer.UV2Kind,accessorType:"VEC2",byteStride:8}];if(l){for(var c=null,f=this.getMeshPrimitiveMode(l),h={},d=0,p=u;d<p.length;d++){var m=p[d],g=m.kind;if(l.isVerticesDataPresent(g)){var T=this.getVertexBufferFromMesh(g,l);m.byteStride=T?4*T.getSize():4*e.VertexBuffer.DeduceStride(g),12===m.byteStride&&(m.accessorType="VEC3"),this.createBufferViewKind(g,a,i,m.byteStride),m.bufferViewIndex=this.bufferViews.length-1,h[g]=m.bufferViewIndex}}if(l.getTotalIndices()){var y=l.getIndices();if(y){var v=4*y.length;n=t._GLTFUtilities.CreateBufferView(0,i.getByteOffset(),v,void 0,"Indices - "+l.name),this.bufferViews.push(n),c=this.bufferViews.length-1;for(var x=0,b=y.length;x<b;++x)i.setUInt32(y[x])}}if(l.subMeshes)for(var A=0,F=l.subMeshes;A<F.length;A++){var _=F[A];o=!1;var M=_.getMaterial(),R=null;if(M)if(l instanceof e.LinesMesh){var C={name:l.name+" material"};(!l.color.equals(e.Color3.White())||l.alpha<1)&&(C.pbrMetallicRoughness={baseColorFactor:l.color.asArray().concat([l.alpha])}),this.materials.push(C),R=this.materials.length-1}else M instanceof e.MultiMaterial?(M=M.subMaterials[_.materialIndex])&&(R=this.materialMap[M.uniqueId]):R=this.materialMap[M.uniqueId];var S=null!=R?this.materials[R]:null,V={attributes:{}};this.setPrimitiveMode(V,f);for(var B=0,E=u;B<E.length;B++){var m=E[B],g=m.kind;if(g!==e.VertexBuffer.UVKind&&g!==e.VertexBuffer.UV2Kind||!S||t._GLTFMaterial._HasTexturesPresent(S)){var w=l.getVerticesData(g);if(w){var T=this.getVertexBufferFromMesh(g,l);if(T){var L=T.getSize(),P=m.bufferViewIndex;if(void 0!=P){s={min:null,max:null},g==e.VertexBuffer.PositionKind&&(s=t._GLTFUtilities.CalculateMinMaxPositions(w,0,w.length/L,this.convertToRightHandedSystem));var G=t._GLTFUtilities.CreateAccessor(P,g+" - "+a.name,m.accessorType,5126,w.length/L,0,s.min,s.max);this.accessors.push(G),this.setAttributeKind(V,g),null==V.attributes.TEXCOORD_0&&null==V.attributes.TEXCOORD_1||(o=!0)}}}}}if(c){var G=t._GLTFUtilities.CreateAccessor(c,"indices - "+a.name,"SCALAR",5125,_.indexCount,4*_.indexStart,null,null);this.accessors.push(G),V.indices=this.accessors.length-1}if(null!=R&&Object.keys(V.attributes).length>0){var N=this.babylonScene.materials[R].sideOrientation;if(this.convertToRightHandedSystem&&N===e.Material.ClockWiseSideOrientation){var I=null!=c?this.bufferViews[c].byteOffset:null;null==I&&(I=0);var U=null;if(null!=c&&(U=l.getIndices()),U)this.reorderIndicesBasedOnPrimitiveMode(_,f,U,I,i);else for(var O=0,D=u;O<D.length;O++){var m=D[O],w=l.getVerticesData(m.kind);if(w){var k=this.bufferViews[h[m.kind]].byteOffset;k||(k=0),this.reorderVertexAttributeDataBasedOnPrimitiveMode(_,f,N,m.kind,w,k,i)}}}if(!o&&t._GLTFMaterial._HasTexturesPresent(this.materials[R])){var K=t._GLTFMaterial._StripTexturesFromMaterial(this.materials[R]);this.materials.push(K),R=this.materials.length-1}V.material=R}r.primitives.push(V)}}},r.prototype.createSceneAsync=function(r,a){var i,n,o,s=this,l={nodes:[]},u=r.transformNodes.concat(r.meshes);return t._GLTFMaterial._ConvertMaterialsToGLTFAsync(r.materials,"image/png",this.images,this.textures,this.samplers,this.materials,this.materialMap,this.imageData,!0).then((function(){s.nodeMap=s.createNodeMapAndAnimations(r,u,s.shouldExportTransformNode,a),s.totalByteLength=a.getByteOffset();for(var t=0,c=u;t<c.length;t++){var f=c[t];if(null!=(i=s.nodeMap[f.uniqueId])&&(n=s.nodes[i],f.parent||(s.shouldExportTransformNode(f)?(s.convertToRightHandedSystem&&(n.translation&&(n.translation[2]*=-1,n.translation[0]*=-1),n.rotation=n.rotation?e.Quaternion.FromArray([0,1,0,0]).multiply(e.Quaternion.FromArray(n.rotation)).asArray():e.Quaternion.FromArray([0,1,0,0]).asArray()),l.nodes.push(i)):e.Tools.Log("Omitting "+f.name+" from scene.")),o=f.getDescendants(!0),!n.children&&o&&o.length)){n.children=[];for(var h=0,d=o;h<d.length;h++){var p=d[h];null!=s.nodeMap[p.uniqueId]&&n.children.push(s.nodeMap[p.uniqueId])}}}l.nodes.length&&s.scenes.push(l)}))},r.prototype.createNodeMapAndAnimations=function(e,r,a,i){for(var n,o,s=this,l={},u={name:"runtime animations",channels:[],samplers:[]},c=[],f=0,h=r;f<h.length;f++){var d=h[f];a(d)?(o=this.createNode(d,i),this.nodes.push(o),n=this.nodes.length-1,l[d.uniqueId]=n,!e.animationGroups.length&&d.animations.length&&t._GLTFAnimation._CreateNodeAnimationFromTransformNodeAnimations(d,u,c,l,this.nodes,i,this.bufferViews,this.accessors,this.convertToRightHandedSystem,this.animationSampleRate)):d.name}return u.channels.length&&u.samplers.length&&this.animations.push(u),c.forEach((function(e){e.channels.length&&e.samplers.length&&s.animations.push(e)})),e.animationGroups.length&&t._GLTFAnimation._CreateNodeAnimationFromAnimationGroups(e,this.animations,l,this.nodes,i,this.bufferViews,this.accessors,this.convertToRightHandedSystem,this.animationSampleRate),l},r.prototype.createNode=function(e,t){var r={},a={primitives:[]};return e.name&&(r.name=e.name),this.setNodeTransformation(r,e),this.setPrimitiveAttributes(a,e,t),a.primitives.length&&(this.meshes.push(a),r.mesh=this.meshes.length-1),r},r})();t._Exporter=r;var a=(function(){function t(e){this._arrayBuffer=new ArrayBuffer(e),this._dataView=new DataView(this._arrayBuffer),this._byteOffset=0}return t.prototype.resizeBuffer=function(e){for(var t=new ArrayBuffer(e),r=new Uint8Array(this._arrayBuffer),a=new Uint8Array(t),i=0,n=a.byteLength;i<n;++i)a[i]=r[i];this._arrayBuffer=t,this._dataView=new DataView(this._arrayBuffer)},t.prototype.getArrayBuffer=function(){return this.resizeBuffer(this.getByteOffset()),this._arrayBuffer},t.prototype.getByteOffset=function(){return this._byteOffset},t.prototype.setUInt8=function(t,r){null!=r?r<this._byteOffset?this._dataView.setUint8(r,t):e.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+1>this._arrayBuffer.byteLength&&this.resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint8(this._byteOffset++,t))},t.prototype.getUInt32=function(t){if(t<this._byteOffset)return this._dataView.getUint32(t,!0);throw e.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"),new Error("BinaryWriter: byteoffset is greater than the current binary buffer length!")},t.prototype.getVector3Float32FromRef=function(t,r){r+8>this._byteOffset?e.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(t.x=this._dataView.getFloat32(r,!0),t.y=this._dataView.getFloat32(r+4,!0),t.z=this._dataView.getFloat32(r+8,!0))},t.prototype.setVector3Float32FromRef=function(t,r){r+8>this._byteOffset?e.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(r,t.x,!0),this._dataView.setFloat32(r+4,t.y,!0),this._dataView.setFloat32(r+8,t.z,!0))},t.prototype.getVector4Float32FromRef=function(t,r){r+12>this._byteOffset?e.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(t.x=this._dataView.getFloat32(r,!0),t.y=this._dataView.getFloat32(r+4,!0),t.z=this._dataView.getFloat32(r+8,!0),t.w=this._dataView.getFloat32(r+12,!0))},t.prototype.setVector4Float32FromRef=function(t,r){r+12>this._byteOffset?e.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(r,t.x,!0),this._dataView.setFloat32(r+4,t.y,!0),this._dataView.setFloat32(r+8,t.z,!0),this._dataView.setFloat32(r+12,t.w,!0))},t.prototype.setFloat32=function(t,r){isNaN(t)&&e.Tools.Error("Invalid data being written!"),null!=r&&(r<this._byteOffset?this._dataView.setFloat32(r,t,!0):e.Tools.Error("BinaryWriter: byteoffset is greater than the current binary length!")),this._byteOffset+4>this._arrayBuffer.byteLength&&this.resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setFloat32(this._byteOffset,t,!0),this._byteOffset+=4},t.prototype.setUInt32=function(t,r){null!=r?r<this._byteOffset?this._dataView.setUint32(r,t,!0):e.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+4>this._arrayBuffer.byteLength&&this.resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint32(this._byteOffset,t,!0),this._byteOffset+=4)},t})();t._BinaryWriter=a})(e.GLTF2||(e.GLTF2={}))})(e||(e={}));var e;!(function(e){var t=(function(){function e(){this.glTFFiles={}}return e.prototype.downloadFiles=function(){function e(e,t){return-1!==e.indexOf(t,e.length-t.length)}for(var t in this.glTFFiles){var r=document.createElement("a");document.body.appendChild(r),r.setAttribute("type","hidden"),r.download=t;var a=this.glTFFiles[t],i=void 0;e(t,".glb")?i={type:"model/gltf-binary"}:e(t,".bin")?i={type:"application/octet-stream"}:e(t,".gltf")?i={type:"model/gltf+json"}:e(t,".jpeg")?i={type:"image/jpeg"}:e(t,".png")&&(i={type:"image/png"}),r.href=window.URL.createObjectURL(new Blob([a],i)),r.click()}},e})();e.GLTFData=t})(e||(e={}));var e;!(function(e){!(function(t){var r=(function(){function t(){}return t.FuzzyEquals=function(t,r,a){return e.Scalar.WithinEpsilon(t.r,r.r,a)&&e.Scalar.WithinEpsilon(t.g,r.g,a)&&e.Scalar.WithinEpsilon(t.b,r.b,a)},t._ConvertMaterialsToGLTFAsync=function(r,a,i,n,o,s,l,u,c){for(var f=[],h=0,d=r;h<d.length;h++){var p=d[h];p instanceof e.StandardMaterial?f.push(t._ConvertStandardMaterialAsync(p,a,i,n,o,s,l,u,c)):p instanceof e.PBRMetallicRoughnessMaterial?f.push(t._ConvertPBRMetallicRoughnessMaterialAsync(p,a,i,n,o,s,l,u,c)):p instanceof e.PBRMaterial?f.push(t._ConvertPBRMaterialAsync(p,a,i,n,o,s,l,u,c)):e.Tools.Warn("Unsupported material type: "+p.name)}return Promise.all(f).then((function(){}))},t._StripTexturesFromMaterial=function(e){var t={};if(e){t.name=e.name,t.doubleSided=e.doubleSided,t.alphaMode=e.alphaMode,t.alphaCutoff=e.alphaCutoff,t.emissiveFactor=e.emissiveFactor;var r=e.pbrMetallicRoughness;r&&(t.pbrMetallicRoughness={},t.pbrMetallicRoughness.baseColorFactor=r.baseColorFactor,t.pbrMetallicRoughness.metallicFactor=r.metallicFactor,t.pbrMetallicRoughness.roughnessFactor=r.roughnessFactor)}return t},t._HasTexturesPresent=function(e){if(e.emissiveTexture||e.normalTexture||e.occlusionTexture)return!0;var t=e.pbrMetallicRoughness;return!(!t||!t.baseColorTexture&&!t.metallicRoughnessTexture)},t._ConvertToGLTFPBRMetallicRoughness=function(t){function r(e,t,r,a,i){return(1-e)*(1-e)*(1-e)*t+3*(1-e)*(1-e)*e*r+3*(1-e)*e*e*a+e*e*e*i}var a=new e.Vector2(0,1),i=new e.Vector2(0,.1),n=new e.Vector2(0,.1),o=new e.Vector2(1300,.1),s=t.diffuseColor.toLinearSpace().scale(.5),l=t.alpha,u=e.Scalar.Clamp(t.specularPower,0,this._maxSpecularPower),c=(function(e){return r(Math.pow(e/o.x,.333333),a.y,i.y,n.y,o.y)})(u);return{baseColorFactor:[s.r,s.g,s.b,l],metallicFactor:0,roughnessFactor:c}},t._SolveMetallic=function(r,a,i){if(a<t._dielectricSpecular.r)return t._dielectricSpecular,0;var n=t._dielectricSpecular.r,o=r*i/(1-t._dielectricSpecular.r)+a-2*t._dielectricSpecular.r,s=t._dielectricSpecular.r-a,l=o*o-4*n*s;return e.Scalar.Clamp((-o+Math.sqrt(l))/(2*n),0,1)},t._GetAlphaMode=function(t){if(t instanceof e.StandardMaterial){var r=t;return 1!==r.alpha||null!=r.diffuseTexture&&r.diffuseTexture.hasAlpha||null!=r.opacityTexture?"BLEND":"OPAQUE"}if(t instanceof e.PBRMetallicRoughnessMaterial){var a=t;switch(a.transparencyMode){case e.PBRMaterial.PBRMATERIAL_OPAQUE:return"OPAQUE";case e.PBRMaterial.PBRMATERIAL_ALPHABLEND:return"BLEND";case e.PBRMaterial.PBRMATERIAL_ALPHATEST:return"MASK";case e.PBRMaterial.PBRMATERIAL_ALPHATESTANDBLEND:return e.Tools.Warn(t.name+": GLTF Exporter | Alpha test and blend mode not supported in glTF.  Alpha blend used instead."),"BLEND";default:return e.Tools.Error("Unsupported alpha mode "+a.transparencyMode),null}}else{if(!(t instanceof e.PBRMaterial))return e.Tools.Error("Unsupported Babylon material type"),null;var i=t;switch(i.transparencyMode){case e.PBRMaterial.PBRMATERIAL_OPAQUE:return"OPAQUE";case e.PBRMaterial.PBRMATERIAL_ALPHABLEND:return"BLEND";case e.PBRMaterial.PBRMATERIAL_ALPHATEST:return"MASK";case e.PBRMaterial.PBRMATERIAL_ALPHATESTANDBLEND:return e.Tools.Warn(t.name+": GLTF Exporter | Alpha test and blend mode not supported in glTF.  Alpha blend used instead."),"BLEND";default:return e.Tools.Error("Unsupported alpha mode "+i.transparencyMode),null}}},t._ConvertStandardMaterialAsync=function(r,a,i,n,o,s,l,u,c){var f=this._GetAlphaMode(r),h="OPAQUE"!==f,d=[],p=t._ConvertToGLTFPBRMetallicRoughness(r),m={name:r.name};if(null==r.backFaceCulling||r.backFaceCulling||(r.twoSidedLighting||e.Tools.Warn(r.name+": Back-face culling enabled and two-sided lighting disabled is not supported in glTF."),m.doubleSided=!0),c){if(r.diffuseTexture){var g=t._ExportTextureAsync(r.diffuseTexture,a,i,n,o,u,h).then((function(e){e&&(p.baseColorTexture=e)}));d.push(g)}if(r.bumpTexture){var g=t._ExportTextureAsync(r.bumpTexture,a,i,n,o,u,h).then((function(e){e&&(m.normalTexture=e,null!=r.bumpTexture&&1!==r.bumpTexture.level&&(m.normalTexture.scale=r.bumpTexture.level))}));d.push(g)}if(r.emissiveTexture){var g=t._ExportTextureAsync(r.emissiveTexture,a,i,n,o,u,h).then((function(e){e&&(m.emissiveTexture=e),m.emissiveFactor=[1,1,1]}));d.push(g)}if(r.ambientTexture){var g=t._ExportTextureAsync(r.ambientTexture,a,i,n,o,u,h).then((function(e){if(e){var t={index:e.index};m.occlusionTexture=t,t.strength=1}}));d.push(g)}}if((r.alpha<1||r.opacityTexture)&&(r.alphaMode===e.Engine.ALPHA_COMBINE?m.alphaMode="BLEND":e.Tools.Warn(r.name+": glTF 2.0 does not support alpha mode: "+r.alphaMode.toString())),r.emissiveColor&&!this.FuzzyEquals(r.emissiveColor,e.Color3.Black(),this._epsilon)&&(m.emissiveFactor=r.emissiveColor.asArray()),m.pbrMetallicRoughness=p,"OPAQUE"!==f)switch(f){case"BLEND":m.alphaMode="BLEND";break;case"MASK":m.alphaMode="MASK",m.alphaCutoff=r.alphaCutOff;break;default:e.Tools.Warn("Unsupported alpha mode "+f)}return s.push(m),l[r.uniqueId]=s.length-1,Promise.all(d).then((function(){}))},t._SetAlphaToOneAsync=function(t,r){return new Promise(function(a,i){if(r)a(t);else{var n=t.getScene();if(n){var o=new e.ProceduralTexture("texture",t.getSize(),"setAlphaToOne",n);o?(o.setTexture("textureSampler",t),o.onLoadObservable.add((function(){a(o)}))):i("Cannot create procedural texture for "+t.name+"!")}else i("Scene not available for texture "+t.name)}})},t._ConvertPBRMetallicRoughnessMaterialAsync=function(r,a,i,n,o,s,l,u,c){var f=[],h={};r.baseColor&&(h.baseColorFactor=[r.baseColor.r,r.baseColor.g,r.baseColor.b,r.alpha]),null!=r.metallic&&1!==r.metallic&&(h.metallicFactor=r.metallic),null!=r.roughness&&1!==r.roughness&&(h.roughnessFactor=r.roughness);var d={name:r.name};r.doubleSided&&(d.doubleSided=r.doubleSided);var p=null,m=!1;if(null!=r.transparencyMode&&(p=t._GetAlphaMode(r))&&"OPAQUE"!==p&&(d.alphaMode=p,"MASK"===p&&(d.alphaCutoff=r.alphaCutOff)),"OPAQUE"!==p&&(m=!0),c){if(null!=r.baseTexture){var g=t._ExportTextureAsync(r.baseTexture,a,i,n,o,u,m).then((function(e){e&&(h.baseColorTexture=e)}));f.push(g)}if(r.normalTexture){var g=t._ExportTextureAsync(r.normalTexture,a,i,n,o,u,m).then((function(e){e&&(d.normalTexture=e,1!==r.normalTexture.level&&(d.normalTexture.scale=r.normalTexture.level))}));f.push(g)}if(r.occlusionTexture){var g=t._ExportTextureAsync(r.occlusionTexture,a,i,n,o,u,m).then((function(e){e&&(d.occlusionTexture=e,null!=r.occlusionStrength&&(d.occlusionTexture.strength=r.occlusionStrength))}));f.push(g)}if(r.emissiveTexture){var g=t._ExportTextureAsync(r.emissiveTexture,a,i,n,o,u,m).then((function(e){e&&(d.emissiveTexture=e)}));f.push(g)}}return this.FuzzyEquals(r.emissiveColor,e.Color3.Black(),this._epsilon)&&(d.emissiveFactor=r.emissiveColor.asArray()),d.pbrMetallicRoughness=h,s.push(d),l[r.uniqueId]=s.length-1,Promise.all(f).then((function(){}))},t._CreateBase64FromCanvas=function(e,t,r,a){var i=document.createElement("canvas");i.width=t,i.height=r,i.id="WriteCanvas";var n=i.getContext("2d"),o=n.createImageData(t,r);return o.data.set(e),n.putImageData(o,0,0),i.toDataURL(a)},t._CreateWhiteTexture=function(t,r,a){for(var i=new Uint8Array(t*r*4),n=0;n<i.length;n+=4)i[n]=i[n+1]=i[n+2]=i[n+3]=255;return e.RawTexture.CreateRGBATexture(i,t,r,a)},t._ResizeTexturesToSameDimensions=function(t,r,a){var i,n,o=t?t.getSize():{width:0,height:0
},s=r?r.getSize():{width:0,height:0};return o.width<s.width?(i=t?e.TextureTools.CreateResizedCopy(t,s.width,s.height,!0):this._CreateWhiteTexture(s.width,s.height,a),n=r):o.width>s.width?(n=r?e.TextureTools.CreateResizedCopy(r,o.width,o.height,!0):this._CreateWhiteTexture(o.width,o.height,a),i=t):(i=t,n=r),{texture1:i,texture2:n}},t._ConvertSpecularGlossinessTexturesToMetallicRoughness=function(t,r,a,i){if(!t&&!r)return e.Tools.Warn("_ConvertSpecularGlosinessTexturesToMetallicRoughness: diffuse and specular glossiness textures are not defined!"),null;var n=t?t.getScene():r?r.getScene():null;if(n){var o=this._ResizeTexturesToSameDimensions(t,r,n),s=o.texture1.getSize(),l=void 0,u=void 0,c=s.width,f=s.height,h=o.texture1.readPixels();if(h instanceof Uint8Array){if(l=o.texture1.readPixels(),(h=o.texture2.readPixels())instanceof Uint8Array){u=o.texture2.readPixels();for(var d=u.byteLength,p=new Uint8Array(d),m=new Uint8Array(d),g=e.Color3.Black(),T=0,y=0,v=0;v<f;++v)for(var x=0;x<c;++x){var b=4*(c*v+x),A=e.Color3.FromInts(l[b],l[b+1],l[b+2]).toLinearSpace().multiply(a.diffuseColor),F=e.Color3.FromInts(u[b],u[b+1],u[b+2]).toLinearSpace().multiply(a.specularColor),_=u[b+3]/255*a.glossiness,M={diffuseColor:A,specularColor:F,glossiness:_},R=this._ConvertSpecularGlossinessToMetallicRoughness(M);g.r=Math.max(g.r,R.baseColor.r),g.g=Math.max(g.g,R.baseColor.g),g.b=Math.max(g.b,R.baseColor.b),T=Math.max(T,R.metallic),y=Math.max(y,R.roughness),m[b]=255*R.baseColor.r,m[b+1]=255*R.baseColor.g,m[b+2]=255*R.baseColor.b,m[b+3]=o.texture1.hasAlpha?l[b+3]:255,p[b]=0,p[b+1]=255*R.roughness,p[b+2]=255*R.metallic,p[b+3]=255}for(var C={baseColor:g,metallic:T,roughness:y},S=!1,V=!1,v=0;v<f;++v)for(var x=0;x<c;++x){var B=4*(c*v+x);m[B]/=C.baseColor.r>this._epsilon?C.baseColor.r:1,m[B+1]/=C.baseColor.g>this._epsilon?C.baseColor.g:1,m[B+2]/=C.baseColor.b>this._epsilon?C.baseColor.b:1;var E=e.Color3.FromInts(m[B],m[B+1],m[B+2]),w=E.toGammaSpace();m[B]=255*w.r,m[B+1]=255*w.g,m[B+2]=255*w.b,this.FuzzyEquals(w,e.Color3.White(),this._epsilon)||(V=!0),p[B+1]/=C.roughness>this._epsilon?C.roughness:1,p[B+2]/=C.metallic>this._epsilon?C.metallic:1;var L=e.Color3.FromInts(255,p[B+1],p[B+2]);this.FuzzyEquals(L,e.Color3.White(),this._epsilon)||(S=!0)}if(S){var P=this._CreateBase64FromCanvas(p,c,f,i);C.metallicRoughnessTextureBase64=P}if(V){var G=this._CreateBase64FromCanvas(m,c,f,i);C.baseColorTextureBase64=G}return C}e.Tools.Error("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Pixel array buffer type not supported for texture: "+o.texture2.name)}else e.Tools.Error("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Pixel array buffer type not supported for texture: "+o.texture1.name)}else e.Tools.Error("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!");return null},t._ConvertSpecularGlossinessToMetallicRoughness=function(r){var a=t._GetPerceivedBrightness(r.diffuseColor),i=t._GetPerceivedBrightness(r.specularColor),n=1-t._GetMaxComponent(r.specularColor),o=t._SolveMetallic(a,i,n),s=r.diffuseColor.scale(n/(1-this._dielectricSpecular.r)/Math.max(1-o,this._epsilon)),l=r.specularColor.subtract(this._dielectricSpecular.scale(1-o)).scale(1/Math.max(o,this._epsilon)),u=e.Color3.Lerp(s,l,o*o);return u=u.clampToRef(0,1,u),{baseColor:u,metallic:o,roughness:1-r.glossiness}},t._GetPerceivedBrightness=function(e){return e?Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b):0},t._GetMaxComponent=function(e){return e?Math.max(e.r,Math.max(e.g,e.b)):0},t._ConvertMetalRoughFactorsToMetallicRoughnessAsync=function(e,r,a,i,n,o,s,l){var u=this._GetAlphaMode(e),c="OPAQUE"!==u,f=[],h={baseColor:e.albedoColor,metallic:e.metallic,roughness:e.roughness};if(l){if(e.albedoTexture){var d=t._ExportTextureAsync(e.albedoTexture,r,a,i,n,s,c).then((function(e){e&&(o.baseColorTexture=e)}));f.push(d)}if(e.metallicTexture){var d=t._ExportTextureAsync(e.metallicTexture,r,a,i,n,s,c).then((function(e){e&&(o.metallicRoughnessTexture=e)}));f.push(d)}}return Promise.all(f).then((function(){return h}))},t._GetGLTFTextureSampler=function(r){var a=t._GetGLTFTextureWrapModesSampler(r),i=r instanceof e.Texture?r.samplingMode:null;if(null!=i)switch(i){case e.Texture.LINEAR_LINEAR:a.magFilter=9729,a.minFilter=9729;break;case e.Texture.LINEAR_NEAREST:a.magFilter=9729,a.minFilter=9728;break;case e.Texture.NEAREST_LINEAR:a.magFilter=9728,a.minFilter=9729;break;case e.Texture.NEAREST_LINEAR_MIPLINEAR:a.magFilter=9728,a.minFilter=9987;break;case e.Texture.NEAREST_NEAREST:a.magFilter=9728,a.minFilter=9728;break;case e.Texture.NEAREST_LINEAR_MIPNEAREST:a.magFilter=9728,a.minFilter=9985;break;case e.Texture.LINEAR_NEAREST_MIPNEAREST:a.magFilter=9729,a.minFilter=9984;break;case e.Texture.LINEAR_NEAREST_MIPLINEAR:a.magFilter=9729,a.minFilter=9986;break;case e.Texture.NEAREST_NEAREST_MIPLINEAR:a.magFilter=9728,a.minFilter=9986;break;case e.Texture.LINEAR_LINEAR_MIPLINEAR:a.magFilter=9729,a.minFilter=9987;break;case e.Texture.LINEAR_LINEAR_MIPNEAREST:a.magFilter=9729,a.minFilter=9985;break;case e.Texture.NEAREST_NEAREST_MIPNEAREST:a.magFilter=9728,a.minFilter=9984}return a},t._GetGLTFTextureWrapMode=function(t){switch(t){case e.Texture.WRAP_ADDRESSMODE:return 10497;case e.Texture.CLAMP_ADDRESSMODE:return 33071;case e.Texture.MIRROR_ADDRESSMODE:return 33648;default:return e.Tools.Error("Unsupported Texture Wrap Mode "+t+"!"),10497}},t._GetGLTFTextureWrapModesSampler=function(r){var a=t._GetGLTFTextureWrapMode(r instanceof e.Texture?r.wrapU:e.Texture.WRAP_ADDRESSMODE),i=t._GetGLTFTextureWrapMode(r instanceof e.Texture?r.wrapV:e.Texture.WRAP_ADDRESSMODE);return 10497===a&&10497===i?{}:{wrapS:a,wrapT:i}},t._ConvertSpecGlossFactorsToMetallicRoughness=function(r,a,i,n,o,s,l,u){var c={diffuseColor:r.albedoColor||e.Color3.White(),specularColor:r.reflectivityColor||e.Color3.White(),glossiness:r.microSurface||1},f=null,h=this._GetGLTFTextureSampler(r.albedoTexture);if(null!=h.magFilter&&null!=h.minFilter&&null!=h.wrapS&&null!=h.wrapT&&(o.push(h),f=o.length-1),r.reflectivityTexture&&!r.useMicroSurfaceFromReflectivityMapAlpha)return e.Tools.Error("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported"),null;var d=this._ConvertSpecularGlossinessTexturesToMetallicRoughness(r.albedoTexture,r.reflectivityTexture,c,a);if(d&&u){if(d.baseColorTextureBase64){var p=t._GetTextureInfoFromBase64(d.baseColorTextureBase64,"bjsBaseColorTexture_"+n.length+".png",a,i,n,r.albedoTexture?r.albedoTexture.coordinatesIndex:null,f,l);null!=p&&(s.baseColorTexture=p)}if(d.metallicRoughnessTextureBase64){var m=t._GetTextureInfoFromBase64(d.metallicRoughnessTextureBase64,"bjsMetallicRoughnessTexture_"+n.length+".png",a,i,n,r.reflectivityTexture?r.reflectivityTexture.coordinatesIndex:null,f,l);null!=m&&(s.metallicRoughnessTexture=m)}return d}return this._ConvertSpecularGlossinessToMetallicRoughness(c)},t._ConvertPBRMaterialAsync=function(e,r,a,i,n,o,s,l,u){var c={},f={name:e.name};if(e.isMetallicWorkflow())return e.albedoColor&&(c.baseColorFactor=[e.albedoColor.r,e.albedoColor.g,e.albedoColor.b,e.alpha]),this._ConvertMetalRoughFactorsToMetallicRoughnessAsync(e,r,a,i,n,c,l,u).then((function(h){return t.SetMetallicRoughnessPbrMaterial(h,e,f,c,r,a,i,n,o,s,l,u)}));var h=this._ConvertSpecGlossFactorsToMetallicRoughness(e,r,a,i,n,c,l,u);return t.SetMetallicRoughnessPbrMaterial(h,e,f,c,r,a,i,n,o,s,l,u)},t.SetMetallicRoughnessPbrMaterial=function(r,a,i,n,o,s,l,u,c,f,h,d){var p=[];if(r){var m=null,g=!1;if(null!=a.transparencyMode&&(m=t._GetAlphaMode(a))&&"OPAQUE"!==m&&(g=!0,i.alphaMode=m,"MASK"===m&&(i.alphaCutoff=a.alphaCutOff)),this.FuzzyEquals(r.baseColor,e.Color3.White(),this._epsilon)&&a.alpha>=this._epsilon||(n.baseColorFactor=[r.baseColor.r,r.baseColor.g,r.baseColor.b,a.alpha]),null!=r.metallic&&1!==r.metallic&&(n.metallicFactor=r.metallic),null!=r.roughness&&1!==r.roughness&&(n.roughnessFactor=r.roughness),null==a.backFaceCulling||a.backFaceCulling||(a.twoSidedLighting||e.Tools.Warn(a.name+": Back-face culling enabled and two-sided lighting disabled is not supported in glTF."),i.doubleSided=!0),d){if(a.bumpTexture){var T=t._ExportTextureAsync(a.bumpTexture,o,s,l,u,h,g).then((function(e){e&&(i.normalTexture=e,1!==a.bumpTexture.level&&(i.normalTexture.scale=a.bumpTexture.level))}));p.push(T)}if(a.ambientTexture){var T=t._ExportTextureAsync(a.ambientTexture,o,s,l,u,h,g).then((function(e){if(e){var t={index:e.index};i.occlusionTexture=t,a.ambientTextureStrength&&(t.strength=a.ambientTextureStrength)}}));p.push(T)}if(a.emissiveTexture){var T=t._ExportTextureAsync(a.emissiveTexture,o,s,l,u,h,g).then((function(e){e&&(i.emissiveTexture=e)}));p.push(T)}}this.FuzzyEquals(a.emissiveColor,e.Color3.Black(),this._epsilon)||(i.emissiveFactor=a.emissiveColor.asArray()),i.pbrMetallicRoughness=n,c.push(i),f[a.uniqueId]=c.length-1}return Promise.all(p).then((function(e){}))},t.GetPixelsFromTexture=function(t){return t.textureType,e.Engine.TEXTURETYPE_UNSIGNED_INT,t.readPixels()},t._ExportTextureAsync=function(r,a,i,n,o,s,l){for(var u=this,c=t._GetGLTFTextureSampler(r),f=null,h=null,d=0;d<o.length;++d){var p=o[d];if(p.minFilter===c.minFilter&&p.magFilter===c.magFilter&&p.wrapS===c.wrapS&&p.wrapT===c.wrapT){h=d;break}}null==h?(o.push(c),f=o.length-1):f=h;var m=e.Tools.RandomId(),g=r.getInternalTexture();null!=g&&(m=g.url||m),m=e.Tools.GetFilename(m);var T=m.split(".")[0],y="";if("image/jpeg"===a)y=".jpg";else{if("image/png"!==a)return Promise.reject("Unsupported mime type "+a);y=".png"}return m=T+y,this._SetAlphaToOneAsync(r,l).then((function(e){var o=t.GetPixelsFromTexture(e),l=r.getSize(),c=u._CreateBase64FromCanvas(o,l.width,l.height,a);return u._GetTextureInfoFromBase64(c,m,a,i,n,r.coordinatesIndex,f,s)}))},t._GetTextureInfoFromBase64=function(e,t,r,a,i,n,o,s){var l=null,u={source:a.length,name:t};null!=o&&(u.sampler=o);for(var c=atob(e.split(",")[1]),f=new ArrayBuffer(c.length),h=new Uint8Array(f),d=0,p=c.length;d<p;++d)h[d]=c.charCodeAt(d);var m={data:h,mimeType:r};if(s[t]=m,"image/jpeg"===r||"image/png"===r){for(var g={uri:t},T=null,d=0;d<a.length;++d)if(a[d].uri===t){T=d;break}null==T?(a.push(g),u.source=a.length-1):u.source=T,i.push(u),l={index:i.length-1},null!=n&&(l.texCoord=n)}return l},t._dielectricSpecular=new e.Color3(.04,.04,.04),t._maxSpecularPower=1024,t._epsilon=1e-6,t})();t._GLTFMaterial=r})(e.GLTF2||(e.GLTF2={}))})(e||(e={}));var e;!(function(e){!(function(t){var r;!(function(e){e[e.INTANGENT=0]="INTANGENT",e[e.OUTTANGENT=1]="OUTTANGENT"})(r||(r={}));var a=(function(){function a(){}return a._CreateNodeAnimation=function(t,r,i,n,o,s){var l=[],u=[],c=r.getKeys(),f=a.calculateMinMaxKeyFrames(c),h=a._DeduceInterpolation(c,i,o),d=f.max-f.min,p=h.interpolationType,m=h.shouldBakeAnimation;if(m?a._CreateBakedAnimation(t,r,i,f.min,f.max,r.framePerSecond,s,l,u,f,n,o):"LINEAR"===p||"STEP"===p?a._CreateLinearOrStepAnimation(t,r,i,d,l,u,n,o):"CUBICSPLINE"===p?a._CreateCubicSplineAnimation(t,r,i,d,l,u,n,o):a._CreateBakedAnimation(t,r,i,f.min,f.max,r.framePerSecond,s,l,u,f,n,o),l.length&&u.length){return{inputs:l,outputs:u,samplerInterpolation:p,inputsMin:m?f.min:e.Tools.FloatRound(f.min/r.framePerSecond),inputsMax:m?f.max:e.Tools.FloatRound(f.max/r.framePerSecond)}}return null},a._DeduceAnimationInfo=function(t){var r=null,a="VEC3",i=!1,n=t.targetProperty.split(".");switch(n[0]){case"scaling":r="scale";break;case"position":r="translation";break;case"rotation":a="VEC4",r="rotation";break;case"rotationQuaternion":a="VEC4",i=!0,r="rotation";break;default:e.Tools.Error("Unsupported animatable property "+n[0])}return r?{animationChannelTargetPath:r,dataAccessorType:a,useQuaternion:i}:(e.Tools.Error("animation channel target path and data accessor type could be deduced"),null)},a._CreateNodeAnimationFromTransformNodeAnimations=function(e,t,r,i,n,o,s,l,u,c){var f;if(e.animations)for(var h=0,d=e.animations;h<d.length;h++){var p=d[h],m=a._DeduceAnimationInfo(p);m&&(f={name:p.name,samplers:[],channels:[]},a.AddAnimation(""+p.name,p.hasRunningRuntimeAnimations?t:f,e,p,m.dataAccessorType,m.animationChannelTargetPath,i,o,s,l,u,m.useQuaternion,c),f.samplers.length&&f.channels.length&&r.push(f))}},a._CreateNodeAnimationFromAnimationGroups=function(t,r,i,n,o,s,l,u,c){var f;if(t.animationGroups)for(var h=t.animationGroups,d=0,p=h;d<p.length;d++){var m=p[d];f={name:m.name,channels:[],samplers:[]};for(var g=0,T=m.targetedAnimations;g<T.length;g++){var y=T[g],v=y.target,x=y.animation;if(v instanceof e.Mesh||1===v.length&&v[0]instanceof e.Mesh){var b=a._DeduceAnimationInfo(y.animation);if(b){var A=v instanceof e.Mesh?v:v[0];a.AddAnimation(""+x.name,f,A,x,b.dataAccessorType,b.animationChannelTargetPath,i,o,s,l,u,b.useQuaternion,c)}}}f.channels.length&&f.samplers.length&&r.push(f)}},a.AddAnimation=function(e,r,i,n,o,s,l,u,c,f,h,d,p){var m,g,T,y,v,x,b,A=a._CreateNodeAnimation(i,n,s,h,d,p);if(A){var F=l[i.uniqueId],_=4*A.inputs.length;m=t._GLTFUtilities.CreateBufferView(0,u.getByteOffset(),_,void 0,e+"  keyframe data view"),c.push(m),A.inputs.forEach((function(e){u.setFloat32(e)})),g=t._GLTFUtilities.CreateAccessor(c.length-1,e+"  keyframes","SCALAR",5126,A.inputs.length,null,[A.inputsMin],[A.inputsMax]),f.push(g),T=f.length-1,v=A.outputs.length,_="VEC3"===o?12*A.outputs.length:16*A.outputs.length,m=t._GLTFUtilities.CreateBufferView(0,u.getByteOffset(),_,void 0,e+"  data view"),c.push(m),A.outputs.forEach((function(e){e.forEach((function(e){u.setFloat32(e)}))})),g=t._GLTFUtilities.CreateAccessor(c.length-1,e+"  data",o,5126,v,null,null,null),f.push(g),y=f.length-1,x={interpolation:A.samplerInterpolation,input:T,output:y},r.samplers.push(x),b={sampler:r.samplers.length-1,target:{node:F,path:s}},r.channels.push(b)}},a._CreateBakedAnimation=function(t,r,i,n,o,s,l,u,c,f,h,d){var p,m,g=e.Quaternion.Identity(),T=null,y=null,v=null,x=null,b=null,A=null;f.min=e.Tools.FloatRound(n/s);for(var F=r.getKeys(),_=0,M=F.length;_<M;++_){if(A=null,v=F[_],_+1<M)if(x=F[_+1],v.value.equals(x.value)){if(0!==_)continue;A=v.frame}else A=x.frame;else{if(b=F[_-1],v.value.equals(b.value))continue;A=o}if(A)for(var R=v.frame;R<=A;R+=l)(m=e.Tools.FloatRound(R/s))!==T&&(T=m,y=m,p=r._interpolate(R,0,void 0,r.loopMode),a._SetInterpolatedValue(t,p,m,r,i,g,u,c,h,d))}y&&(f.max=y)},a._ConvertFactorToVector3OrQuaternion=function(t,r,i,n,o,s,l){var u,c,f=null,h=a._GetBasePositionRotationOrScale(r,o,s,l);if(n===e.Animation.ANIMATIONTYPE_FLOAT)switch(u=i.targetProperty.split("."),c=u?u[1]:"",f=l?e.Quaternion.FromArray(h).normalize():e.Vector3.FromArray(h),c){case"x":case"y":f[c]=s&&l&&"scale"!==o?-t:t;break;case"z":f[c]=s&&!l&&"scale"!==o?-t:t;break;case"w":f.w=t;break;default:e.Tools.Error('glTFAnimation: Unsupported component type "'+c+'" for scale animation!')}return f},a._SetInterpolatedValue=function(r,a,i,n,o,s,l,u,c,f){var h,d=n.dataType;l.push(i),"number"==typeof a&&(a=this._ConvertFactorToVector3OrQuaternion(a,r,n,d,o,c,f)),a&&("rotation"===o?(f?s=a:(h=a,e.Quaternion.RotationYawPitchRollToRef(h.y,h.x,h.z,s)),c&&(t._GLTFUtilities.GetRightHandedQuaternionFromRef(s),r.parent||(s=e.Quaternion.FromArray([0,1,0,0]).multiply(s))),u.push(s.asArray())):(h=a,c&&"scale"!==o&&(t._GLTFUtilities.GetRightHandedPositionVector3FromRef(h),r.parent||(h.x*=-1,h.z*=-1)),u.push(h.asArray())))},a._CreateLinearOrStepAnimation=function(e,t,r,i,n,o,s,l){for(var u=0,c=t.getKeys();u<c.length;u++){var f=c[u];n.push(f.frame/t.framePerSecond),a._AddKeyframeValue(f,t,o,r,e,s,l)}},a._CreateCubicSplineAnimation=function(e,t,i,n,o,s,l,u){t.getKeys().forEach((function(c){o.push(c.frame/t.framePerSecond),a.AddSplineTangent(e,r.INTANGENT,s,i,"CUBICSPLINE",c,n,u,l),a._AddKeyframeValue(c,t,s,i,e,l,u),a.AddSplineTangent(e,r.OUTTANGENT,s,i,"CUBICSPLINE",c,n,u,l)}))},a._GetBasePositionRotationOrScale=function(r,a,i,n){var o;return"rotation"===a?n?r.rotationQuaternion?(o=r.rotationQuaternion.asArray(),i&&(t._GLTFUtilities.GetRightHandedQuaternionArrayFromRef(o),r.parent||(o=e.Quaternion.FromArray([0,1,0,0]).multiply(e.Quaternion.FromArray(o)).asArray()))):o=e.Quaternion.Identity().asArray():(o=r.rotation.asArray(),t._GLTFUtilities.GetRightHandedNormalArray3FromRef(o)):"translation"===a?(o=r.position.asArray(),i&&t._GLTFUtilities.GetRightHandedPositionArray3FromRef(o)):o=r.scaling.asArray(),o},a._AddKeyframeValue=function(r,a,i,n,o,s,l){var u,c,f=a.dataType;if(f===e.Animation.ANIMATIONTYPE_VECTOR3){if(u=r.value.asArray(),"rotation"===n){var h=e.Vector3.FromArray(u),d=e.Quaternion.RotationYawPitchRoll(h.y,h.x,h.z);s&&(t._GLTFUtilities.GetRightHandedQuaternionFromRef(d),o.parent||(d=e.Quaternion.FromArray([0,1,0,0]).multiply(d))),u=d.asArray()}else"translation"===n&&s&&(t._GLTFUtilities.GetRightHandedNormalArray3FromRef(u),o.parent||(u[0]*=-1,u[2]*=-1));i.push(u)}else if(f===e.Animation.ANIMATIONTYPE_FLOAT){if(c=this._ConvertFactorToVector3OrQuaternion(r.value,o,a,f,n,s,l)){if("rotation"===n){var p=l?c:e.Quaternion.RotationYawPitchRoll(c.y,c.x,c.z).normalize();s&&(t._GLTFUtilities.GetRightHandedQuaternionFromRef(p),o.parent||(p=e.Quaternion.FromArray([0,1,0,0]).multiply(p))),i.push(p.asArray())}else"translation"===n&&s&&(t._GLTFUtilities.GetRightHandedNormalVector3FromRef(c),o.parent||(c.x*=-1,c.z*=-1));i.push(c.asArray())}}else f===e.Animation.ANIMATIONTYPE_QUATERNION?(u=r.value.normalize().asArray(),s&&(t._GLTFUtilities.GetRightHandedQuaternionArrayFromRef(u),o.parent||(u=e.Quaternion.FromArray([0,1,0,0]).multiply(e.Quaternion.FromArray(u)).asArray())),i.push(u)):e.Tools.Error("glTFAnimation: Unsupported key frame values for animation!")},a._DeduceInterpolation=function(t,r,a){var i,n,o=!1;if("rotation"===r&&!a)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(var s=0,l=t.length;s<l;++s)if(n=t[s],n.inTangent||n.outTangent)if(i){if("CUBICSPLINE"!==i){i="LINEAR",o=!0;break}}else i="CUBICSPLINE";else if(i){if("CUBICSPLINE"===i||n.interpolation&&n.interpolation===e.AnimationKeyInterpolation.STEP&&"STEP"!==i){i="LINEAR",o=!0;break}}else i=n.interpolation&&n.interpolation===e.AnimationKeyInterpolation.STEP?"STEP":"LINEAR";return i||(i="LINEAR"),{interpolationType:i,shouldBakeAnimation:o}},a.AddSplineTangent=function(a,i,n,o,s,l,u,c,f){var h,d=i===r.INTANGENT?l.inTangent:l.outTangent;if("CUBICSPLINE"===s){if("rotation"===o)if(d){if(c)h=d.scale(u).asArray();else{var p=d.scale(u);h=e.Quaternion.RotationYawPitchRoll(p.y,p.x,p.z).asArray()}f&&(t._GLTFUtilities.GetRightHandedQuaternionArrayFromRef(h),a.parent||(h=e.Quaternion.FromArray([0,1,0,0]).multiply(e.Quaternion.FromArray(h)).asArray()))}else h=[0,0,0,0];else d?(h=d.scale(u).asArray(),f&&"translation"===o&&(t._GLTFUtilities.GetRightHandedPositionArray3FromRef(h),a.parent||(h[0]*=-1,h[2]*=-1))):h=[0,0,0];n.push(h)}},a.calculateMinMaxKeyFrames=function(e){var t=1/0,r=-1/0;return e.forEach((function(e){t=Math.min(t,e.frame),r=Math.max(r,e.frame)})),{min:t,max:r}},a})();t._GLTFAnimation=a})(e.GLTF2||(e.GLTF2={}))})(e||(e={}));var e;return (function(e){!(function(t){var r=(function(){function t(){}return t.CreateBufferView=function(e,t,r,a,i){var n={buffer:e,byteLength:r};return t&&(n.byteOffset=t),i&&(n.name=i),a&&(n.byteStride=a),n},t.CreateAccessor=function(e,t,r,a,i,n,o,s){var l={name:t,bufferView:e,componentType:a,count:i,type:r};return null!=o&&(l.min=o),null!=s&&(l.max=s),null!=n&&(l.byteOffset=n),l},t.CalculateMinMaxPositions=function(r,a,i,n){var o,s,l,u=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];if(i)for(var f=a,h=a+i;f<h;++f){o=3*f,s=e.Vector3.FromArray(r,o),n&&t.GetRightHandedPositionVector3FromRef(s),l=s.asArray();for(var d=0;d<3;++d){var p=l[d];p<u[d]&&(u[d]=p),p>c[d]&&(c[d]=p),++o}}return{min:u,max:c}},t.GetRightHandedPositionVector3=function(t){return new e.Vector3(t.x,t.y,-t.z)},t.GetRightHandedPositionVector3FromRef=function(e){e.z*=-1},t.GetRightHandedPositionArray3FromRef=function(e){e[2]*=-1},t.GetRightHandedNormalVector3=function(t){return new e.Vector3(t.x,t.y,-t.z)},t.GetRightHandedNormalVector3FromRef=function(e){e.z*=-1},t.GetRightHandedNormalArray3FromRef=function(e){e[2]*=-1},t.GetRightHandedVector4FromRef=function(e){e.z*=-1,e.w*=-1},t.GetRightHandedArray4FromRef=function(e){e[2]*=-1,e[3]*=-1},t.GetRightHandedQuaternionFromRef=function(e){e.x*=-1,e.y*=-1},t.GetRightHandedQuaternionArrayFromRef=function(e){e[0]*=-1,e[1]*=-1},t})();t._GLTFUtilities=r})(e.GLTF2||(e.GLTF2={}))})(e||(e={})),e}));