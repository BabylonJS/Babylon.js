const MonacoWebpackPlugin = require("monaco-editor-webpack-plugin");
const ReactRefreshWebpackPlugin = require("@pmmmwh/react-refresh-webpack-plugin");
const HtmlWebpackPlugin = require("html-webpack-plugin");
const webpackTools = require("@dev/build-tools").webpackTools;
const path = require("path");

const monacoEditorRegEx = new RegExp('node_modules/monaco-editor');

module.exports = (env) => {
    const production = env.mode === "production" || process.env.NODE_ENV === "production";
    const BUILD_ID = process.env.BUILD_BUILDID || process.env.BUILD_SOURCEVERSION || String(Date.now());
    // eslint-disable-next-line no-console
    console.log(`Building playground in ${production ? "production" : "development"} mode using build id: ${BUILD_ID}`);
    const commonConfig = {
        entry: "./src/legacy/legacy.ts",
        ...webpackTools.commonDevWebpackConfiguration(
            {
                ...env,
                outputFilename: "babylon.playground.js",
                dirName: __dirname,
                enableHotReload: true,
            },
            {
                static: ["public"],
                port: process.env.PLAYGROUND_PORT || 1338,
            },
            [
                new MonacoWebpackPlugin({
                    languages: ["typescript", "javascript"],
                    filename: "[name].[contenthash].worker.js",
                    monacoEditorPath: path.resolve("../../../node_modules/monaco-editor"),
                }),
            ]
        ),
        resolve: {
            extensions: [".js", ".ts", ".tsx", ".scss", "*.svg"],
            alias: {
                "shared-ui-components": path.resolve("../../dev/sharedUiComponents/dist"),
            },
        },
        externals: {
            "@dev/core": "BABYLON",
        },
        module: {
            rules: webpackTools.getRules({
                sideEffects: true,
                includeCSS: true,
                extraRules: [
                    {
                        test: /\.ttf$/,
                        type: "asset/resource",
                    },
                    {
                        test: /\.svg$/,
                        use: ["@svgr/webpack"],
                    },
                    {
                        test: /\.js$/,
                        include: monacoEditorRegEx,
                        loader: 'string-replace-loader',
                        options: {
                            multiple: [
                                {
                                    // initialValidationRegex
                                    search: /\(\?<=(\['"\\s\])\)/g,
                                    replace: '(?:$1|^)',
                                    flags: 'g'
                                },
                                {
                                    // wordBoundaryToMaintain
                                    search: /\(\?<=(\\\\\.)\)/g,
                                    replace: '(?:$1|^)',
                                    flags: 'g'
                                }
                            ]
                        }
                    },
                    {
                        test: /\.js$/,
                        include: monacoEditorRegEx,
                        use: {
                            loader: "ts-loader",
                            options: {
                                transpileOnly: true,
                                compilerOptions: {
                                    target: "ES2021",
                                }
                            }
                        }
                    }
                ],
                tsOptions: {
                    compilerOptions: {
                        rootDir: "../../",
                    },
                },
            }),
        },
    };
    const plugins = (commonConfig.plugins || []).filter((p) => !(p && p.constructor && p.constructor.name === "ReactRefreshWebpackPlugin"));
    return {
        ...commonConfig,
        output: {
            ...(commonConfig.output || {}),
            filename: `babylon.playground.[fullhash].js`,
            chunkFilename: `[name].[fullhash].js`,
            assetModuleFilename: `assets/[name].[fullhash][ext]`,
            hashSalt: BUILD_ID,
            publicPath: commonConfig.output?.publicPath ?? "auto",
        },
        devServer: {
            ...(commonConfig.devServer || {}),
            client: {
                ...(commonConfig.devServer?.client || {}),
                overlay: false,
            },
        },
        plugins: [
            ...plugins,
            new HtmlWebpackPlugin({
                template: path.resolve(__dirname, "debug.html"),
                filename: "debug.html",
                templateParameters: (compilation) => ({
                    PLAYGROUND_BUNDLE: `babylon.playground.${compilation.hash}.js`,
                }),
                inject: false,
            }),
            new HtmlWebpackPlugin({
                template: path.resolve(__dirname, "frame.html"),
                filename: "frame.html",
                templateParameters: (compilation) => ({
                    PLAYGROUND_BUNDLE: `babylon.playground.${compilation.hash}.js`,
                }),
                inject: false,
            }),
            new HtmlWebpackPlugin({
                template: path.resolve(__dirname, "full.html"),
                filename: "full.html",
                templateParameters: (compilation) => ({
                    PLAYGROUND_BUNDLE: `babylon.playground.${compilation.hash}.js`,
                }),
                inject: false,
            }),
            new HtmlWebpackPlugin({
                template: path.resolve(__dirname, "index.html"),
                templateParameters: (compilation) => ({
                    PLAYGROUND_BUNDLE: `babylon.playground.${compilation.hash}.js`,
                }),
                inject: false,
            }),
            !production && new ReactRefreshWebpackPlugin({ overlay: false }),
        ].filter(Boolean),
    };
};
